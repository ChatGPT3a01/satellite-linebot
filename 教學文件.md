# 衛星氣象資料 Line Bot 完整教學

## 專案概述

這個專案使用 Google Apps Script (GAS) 建立一個 Line Bot，可以查詢：
- 天氣資料 (OpenWeatherMap)
- 洋流/海洋資料 (Stormglass)
- 衛星雲圖 (向日葵衛星/Windy/NASA)

---

## 第一部分：申請 API Key

### 1. OpenWeatherMap (天氣 API)

**網址**：https://openweathermap.org/api

**步驟**：
1. 前往 https://openweathermap.org/
2. 點擊右上角「Sign In」→「Create an Account」
3. 填寫 Email、密碼，完成註冊
4. 登入後，點擊右上角用戶名稱 → 「My API keys」
5. 複製 API Key (或點擊 Generate 產生新的)

**免費方案**：
- 每分鐘 60 次請求
- 每月 1,000,000 次請求
- 完全免費

---

### 2. Stormglass (海洋/洋流 API)

**網址**：https://stormglass.io/

**步驟**：
1. 前往 https://stormglass.io/
2. 點擊「Get Started」或「Sign Up」
3. 使用 Google 或 Email 註冊
4. 註冊後進入 Dashboard
5. 複製 API Key

**免費方案**：
- 每天 10 次請求
- 適合個人學習使用

---

### 3. Line Messaging API

**網址**：https://developers.line.biz/

**步驟**：
1. 前往 https://developers.line.biz/console/
2. 使用 Line 帳號登入
3. 點擊「Create」建立新的 Provider
4. 輸入 Provider 名稱（例如：我的氣象機器人）
5. 點擊「Create a Messaging API channel」
6. 填寫：
   - Channel name：衛星氣象機器人
   - Channel description：查詢天氣、洋流、衛星雲圖
   - Category：選擇適當類別
   - Subcategory：選擇適當子類別
7. 同意條款並建立
8. 在「Messaging API」分頁：
   - 複製「Channel access token」(點擊 Issue 產生)
   - 記下「Bot basic ID」（加好友用）

---

## 第二部分：建立 Google Sheet

### 步驟

1. 前往 https://sheets.google.com/
2. 建立新的空白試算表
3. 將試算表命名為「衛星氣象資料」
4. 記下試算表 ID（網址中的長字串）：
   ```
   https://docs.google.com/spreadsheets/d/【這段就是ID】/edit
   ```

### Google Sheet 結構

程式會自動建立以下工作表：

#### 工作表 1：查詢記錄
| 時間戳記 | 使用者ID | 查詢內容 |
|---------|---------|---------|
| 2024/1/1 12:00:00 | Uxxxxxxx | 天氣 |

#### 工作表 2：天氣資料
| 時間戳記 | 位置 | 溫度 | 體感溫度 | 濕度 | 風速 | 天氣描述 |
|---------|------|------|---------|------|------|---------|
| 2024/1/1 12:00:00 | Taipei | 25 | 27 | 80 | 3.5 | 多雲 |

#### 工作表 3：海洋資料
| 時間戳記 | 浪高 | 週期 | 水溫 | 洋流速度 | 洋流方向 |
|---------|------|------|------|---------|---------|
| 2024/1/1 12:00:00 | 1.2 | 8 | 24 | 0.3 | 180 |

#### 工作表 4：錯誤記錄
| 時間戳記 | 函式名稱 | 錯誤訊息 |
|---------|---------|---------|
| 2024/1/1 12:00:00 | getWeatherData | API Error |

---

## 第三部分：設定 Google Apps Script

### 步驟

1. 在 Google Sheet 中，點擊「擴充功能」→「Apps Script」
2. 刪除預設的程式碼
3. 複製 `Code.gs` 的內容貼上
4. 修改 `CONFIG` 設定區域：

```javascript
const CONFIG = {
  // Line Bot 設定
  LINE_CHANNEL_ACCESS_TOKEN: '貼上你的 Line Channel Access Token',

  // OpenWeatherMap 設定
  OPENWEATHER_API_KEY: '貼上你的 OpenWeatherMap API Key',

  // Stormglass 設定
  STORMGLASS_API_KEY: '貼上你的 Stormglass API Key',

  // 預設位置 (可自行修改)
  DEFAULT_LAT: 25.0330,  // 緯度
  DEFAULT_LON: 121.5654, // 經度

  // Google Sheet 設定
  SHEET_ID: '貼上你的 Google Sheet ID',
  LOG_SHEET_NAME: '查詢記錄',
  WEATHER_SHEET_NAME: '天氣資料',
  OCEAN_SHEET_NAME: '海洋資料'
};
```

### 測試 API

1. 在 Apps Script 編輯器中
2. 選擇函式「testWeatherAPI」
3. 點擊「執行」
4. 首次執行需要授權，點擊「審查權限」並允許
5. 查看執行記錄，確認 API 正常運作

---

## 第四部分：部署為 Web App

### 步驟

1. 在 Apps Script 編輯器中
2. 點擊右上角「部署」→「新增部署作業」
3. 點擊齒輪圖示，選擇「網頁應用程式」
4. 設定：
   - 說明：衛星氣象 Line Bot v1.0
   - 執行身分：我
   - 誰可以存取：所有人
5. 點擊「部署」
6. 複製「網頁應用程式網址」

---

## 第五部分：設定 Line Webhook

### 步驟

1. 回到 Line Developers Console
2. 進入你的 Channel
3. 在「Messaging API」分頁
4. 找到「Webhook settings」
5. 開啟「Use webhook」
6. 在「Webhook URL」貼上 GAS 網頁應用程式網址
7. 點擊「Verify」測試連線
8. 如果顯示「Success」表示成功

### 關閉自動回覆

1. 在同一頁面找到「LINE Official Account features」
2. 點擊「Edit」進入 Line Official Account Manager
3. 關閉「自動回應訊息」
4. 關閉「加入好友的歡迎訊息」（或自訂）

---

## 第六部分：測試機器人

### 加入好友

1. 在 Line Developers Console
2. 找到 QR Code 或 Bot basic ID
3. 用 Line 掃描或搜尋 ID 加好友

### 測試指令

傳送以下訊息測試：

| 指令 | 功能 |
|-----|------|
| `天氣` | 查詢天氣狀況 |
| `洋流` | 查詢海洋/洋流資料 |
| `衛星` | 取得衛星雲圖連結 |
| `全部` | 查詢所有資料 |
| `說明` | 顯示使用說明 |

---

## API 說明

### OpenWeatherMap 回傳資料

```json
{
  "location": "Taipei",
  "description": "多雲",
  "temperature": 25,
  "feelsLike": 27,
  "humidity": 80,
  "pressure": 1013,
  "windSpeed": 3.5,
  "windDeg": 180,
  "clouds": 75,
  "visibility": 10000,
  "sunrise": "06:30:00",
  "sunset": "17:30:00"
}
```

### Stormglass 回傳資料

```json
{
  "waveHeight": 1.2,
  "wavePeriod": 8,
  "waveDirection": 180,
  "waterTemperature": 24,
  "currentSpeed": 0.3,
  "currentDirection": 90,
  "seaLevel": 0.5
}
```

---

## 常見問題

### Q1: Webhook 驗證失敗？

**解決方案**：
1. 確認網址正確（結尾是 /exec）
2. 確認部署時選擇「所有人」可存取
3. 重新部署一次

### Q2: API 回傳錯誤？

**解決方案**：
1. 檢查 API Key 是否正確
2. 確認免費額度未用完
3. 查看 Google Sheet 的「錯誤記錄」工作表

### Q3: Stormglass 請求次數不夠？

**解決方案**：
1. 免費版每天只有 10 次
2. 可考慮升級付費方案
3. 或使用其他替代 API

### Q4: 如何修改查詢位置？

**解決方案**：
修改 `CONFIG` 中的經緯度：
```javascript
DEFAULT_LAT: 25.0330,  // 台北緯度
DEFAULT_LON: 121.5654, // 台北經度
```

常用地點經緯度：
- 台北：25.0330, 121.5654
- 高雄：22.6273, 120.3014
- 台中：24.1477, 120.6736
- 花蓮：23.9871, 121.6011

---

## 進階功能

### 1. 定時推送天氣

在 Apps Script 中設定觸發條件：

```javascript
// 設定每日早上 7 點推送天氣
function setupDailyTrigger() {
  ScriptApp.newTrigger('sendDailyWeather')
    .timeBased()
    .atHour(7)
    .everyDays(1)
    .create();
}

function sendDailyWeather() {
  const userId = '你的 Line User ID';
  const messages = getWeatherResponse();
  pushMessage(userId, messages);
}
```

### 2. 支援多位置查詢

修改 handleMessage 函式：

```javascript
// 支援「天氣 高雄」格式
if (userMessage.startsWith('天氣 ')) {
  const location = userMessage.replace('天氣 ', '');
  // 使用 Geocoding API 轉換地名為經緯度
  replyMessages = getWeatherResponse(location);
}
```

---

## 檔案結構

```
satellite-linebot/
├── Code.gs          # 主程式碼
├── 教學文件.md      # 本教學文件
└── Google Sheet     # 資料儲存
    ├── 查詢記錄
    ├── 天氣資料
    ├── 海洋資料
    └── 錯誤記錄
```

---

## 資源連結

- [OpenWeatherMap API 文件](https://openweathermap.org/api)
- [Stormglass API 文件](https://docs.stormglass.io/)
- [Line Messaging API 文件](https://developers.line.biz/en/docs/messaging-api/)
- [Google Apps Script 文件](https://developers.google.com/apps-script)

---

## 版本記錄

- v1.0 - 初始版本
  - 天氣查詢 (OpenWeatherMap)
  - 洋流查詢 (Stormglass)
  - 衛星雲圖連結
  - Google Sheet 記錄功能
